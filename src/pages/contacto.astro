---
import Layout from "../layouts/main.astro";
---

<Layout title="Formulario de Contacto">
  <h1 class="text-3xl font-bold text-center my-8">Formulario de Contacto</h1>
  <form id="contact-form" class="max-w-xl mx-auto px-4">
    <div class="mb-4">
      <label for="name" class="block text-gray-700 font-semibold mb-2"
        >Nombre:</label
      >
      <input
        type="text"
        id="name"
        name="name"
        required
        title="Solo letras"
        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>

    <div class="mb-4">
      <label for="email" class="block text-gray-700 font-semibold mb-2"
        >Correo Electrónico:</label
      >
      <input
        type="email"
        id="email"
        name="email"
        required
        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>

    <div class="mb-4">
      <label for="message" class="block text-gray-700 font-semibold mb-2"
        >Mensaje:</label
      >
      <textarea
        id="message"
        name="message"
        required
        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical min-h-[120px]"
      ></textarea>
    </div>

    <!-- Widget de Turnstile -->
    <div
      class="cf-turnstile mb-4"
      data-sitekey="0x4AAAAAAAwmjYdGGjEprZat"
      id="turnstile-widget"
    >
    </div>

    <button
      type="submit"
      class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition-colors"
    >
      Enviar
    </button>
  </form>

  <div
    id="status-message"
    class="max-w-xl mx-auto px-4 mt-4 text-center text-red-600"
  >
  </div>
</Layout>

<script is:inline>
  document
    .getElementById("contact-form")
    .addEventListener("submit", async function (event) {
      event.preventDefault(); // Evita la recarga de la página

      const form = event.target;
      const formData = new FormData(form);

      // Obtener el token de Turnstile
      const turnstileToken = formData.get("cf-turnstile-response");

      if (!turnstileToken) {
        document.getElementById("status-message").innerHTML =
          "Fallo en la verificación de Turnstile. Por favor, inténtalo de nuevo.";
        return;
      }

      try {
        const response = await fetch(
          "https://resend-email-worker.fj-verachamorro.workers.dev/",
          {
            method: "POST",
            body: formData,
            credentials: "include",
          }
        );

        const statusMessage = document.getElementById("status-message");
        const result = await response.json(); // Parsear el JSON del Worker

        if (response.ok) {
          statusMessage.innerHTML = "Tu mensaje ha sido enviado exitosamente.";
          // Si es exitoso pintar en verde el mensaje añadiendo la clase text-green-600
          statusMessage.classList.remove("text-red-600");
          statusMessage.classList.add("text-green-600");
          form.reset(); // Limpiar el formulario

          // Reiniciar el widget de Turnstile
          turnstile.reset("#turnstile-widget");
        } else {
          statusMessage.innerHTML = "Hubo un error: " + result.error;
          statusMessage.classList.remove("text-green-600");
          statusMessage.classList.add("text-red-600");
        }
      } catch (error) {
        const statusMessage = document.getElementById("status-message");
        statusMessage.innerHTML = "Hubo un problema al procesar el formulario.";
      }
    });
</script>

<!-- Añadir el script de Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer
></script>
