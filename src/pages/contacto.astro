---
import Layout from "../layouts/main.astro";
---

<Layout title="My Writing">
  <h1>Formulario de Contacto</h1>
  <form id="contact-form">
    <label for="name">Nombre:</label>
    <input
      type="text"
      id="name"
      name="name"
      required
      pattern="[A-Za-z\s]+"
      title="Solo letras"
    /><br /><br />

    <label for="email">Correo Electrónico:</label>
    <input type="email" id="email" name="email" required /><br /><br />

    <label for="message">Mensaje:</label>
    <textarea id="message" name="message" required></textarea><br /><br />

    <!-- Añadir el widget de Turnstile -->
    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAwmjYdGGjEprZat"></div><br
    />

    <button type="submit">Enviar</button>
  </form>

  <div id="status-message"></div>
</Layout>
<script is:inline>
  document
    .getElementById("contact-form")
    .addEventListener("submit", async function (event) {
      event.preventDefault(); // Evita la recarga de la página

      const form = event.target;
      const formData = new FormData(form);

      // Obtener el token de Turnstile
      const turnstileToken = formData.get("cf-turnstile-response");

      if (!turnstileToken) {
        document.getElementById("status-message").innerHTML =
          "Fallo en la verificación de Turnstile. Por favor, inténtalo de nuevo.";
        return;
      }

      try {
        const response = await fetch(
          "https://resend-email-worker.fj-verachamorro.workers.dev/",
          {
            method: "POST",
            body: formData,
            credentials: "include",
          }
        );

        const statusMessage = document.getElementById("status-message");
        const result = await response.json(); // Parsear el JSON del Worker

        if (response.ok) {
          statusMessage.innerHTML = "Tu mensaje ha sido enviado exitosamente."; // Mostrar mensaje general de éxito
          form.reset(); // Limpiar el formulario
        } else {
          statusMessage.innerHTML = "Hubo un error: " + result.error; // Mostrar el error del Worker
        }
      } catch (error) {
        const statusMessage = document.getElementById("status-message");
        statusMessage.innerHTML = "Hubo un problema al procesar el formulario.";
      }
    });
</script>
